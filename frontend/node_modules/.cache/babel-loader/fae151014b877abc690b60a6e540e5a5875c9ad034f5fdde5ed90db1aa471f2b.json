{"ast":null,"code":"//create a new session component\nimport React,{useState,useRef,useEffect}from\"react\";import axios from\"axios\";import API_BASE_URL from\"../config/api\";import\"../styles/StudentForm.css\";import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const StudentForm=_ref=>{let{togglePopup}=_ref;//eslint-disable-next-line\nconst[token,setToken]=useState(localStorage.getItem(\"token\")||\"\");const[image,setImage]=useState(null);const[photoData,setPhotoData]=useState(\"\");// To store the captured photo data\nconst[isCameraActive,setIsCameraActive]=useState(false);const videoRef=useRef(null);const constraints={video:true};const startCamera=()=>{if(!videoRef.current){console.error(\"Video element not available\");return;}navigator.mediaDevices.getUserMedia(constraints).then(stream=>{if(videoRef.current){videoRef.current.srcObject=stream;setIsCameraActive(true);}}).catch(error=>{console.error(\"Error accessing camera:\",error);alert(\"Unable to access camera. Please check your camera permissions.\");});};const stopCamera=()=>{if(!videoRef.current||!videoRef.current.srcObject){return;}const stream=videoRef.current.srcObject;const tracks=stream.getTracks();tracks.forEach(track=>track.stop());videoRef.current.srcObject=null;setIsCameraActive(false);};const capturePhoto=async()=>{if(!videoRef.current){alert(\"Camera not available. Please start the camera first.\");return;}const canvas=document.createElement(\"canvas\");canvas.width=videoRef.current.videoWidth;canvas.height=videoRef.current.videoHeight;canvas.getContext(\"2d\").drawImage(videoRef.current,0,0,canvas.width,canvas.height);const photoDataUrl=canvas.toDataURL(\"image/png\");setImage(await fetch(photoDataUrl).then(res=>res.blob()));setPhotoData(photoDataUrl);stopCamera();};const ResetCamera=()=>{setPhotoData(\"\");setImage(null);startCamera();};const AttendSession=async e=>{e.preventDefault();console.log(\"AttendSession function called\");console.log(\"Event:\",e);let regno=e.target.regno.value;console.log(\"Regno:\",regno);console.log(\"Token:\",token?\"Present\":\"Missing\");console.log(\"Image:\",image?\"Present\":\"Missing\");console.log(\"Session ID:\",localStorage.getItem(\"session_id\"));console.log(\"Teacher Email:\",localStorage.getItem(\"teacher_email\"));console.log(\"Student Email:\",localStorage.getItem(\"email\"));if(!token){console.error(\"No token found - redirecting to login\");alert(\"Session expired. Please login again.\");localStorage.removeItem('token');window.location.href='/login';return;}//get user IP address\naxios.defaults.withCredentials=false;const res=await axios.get(\"https://api64.ipify.org?format=json\");axios.defaults.withCredentials=true;//\nlet IP=res.data.ip;if(navigator.geolocation){console.log(\"Geolocation is supported!\");navigator.geolocation.getCurrentPosition(async position=>{const{latitude,longitude}=position.coords;let locationString=\"\".concat(latitude,\",\").concat(longitude);if(regno.length>0){if(!image){console.error(\"No image captured\");alert(\"Please capture a photo before submitting attendance!\");return;}console.log(\"Creating FormData with:\");const formData=new FormData();formData.append('token',token);formData.append('regno',regno);formData.append('session_id',localStorage.getItem(\"session_id\"));formData.append('teacher_email',localStorage.getItem(\"teacher_email\"));formData.append('IP',IP);formData.append('date',new Date().toISOString().split(\"T\")[0]);formData.append('Location',locationString);formData.append('student_email',localStorage.getItem(\"email\"));formData.append('image',image,'attendance-photo.png');// Log FormData contents\nconsole.log(\"FormData entries:\");for(let[key,value]of formData.entries()){console.log(\"\".concat(key,\": \").concat(typeof value==='object'&&value instanceof File?\"File(\".concat(value.name,\", \").concat(value.size,\" bytes)\"):value));}console.log(\"Making API call to:\",\"\".concat(API_BASE_URL,\"/sessions/attend_session\"));try{const response=await axios.post(\"\".concat(API_BASE_URL,\"/sessions/attend_session\"),formData,{headers:{\"Content-Type\":\"multipart/form-data\"}});console.log(\"API Response:\",response);console.log(\"Response status:\",response.status);console.log(\"Response data:\",response.data);//replace the contents of the popup with success message\ndocument.querySelector(\".form-popup-inner\").innerHTML=\"\\n                <div style=\\\"text-align: center; padding: 20px;\\\">\\n                  <div style=\\\"font-size: 48px; margin-bottom: 15px;\\\">\\u2705</div>\\n                  <h3 style=\\\"color: #27ae60; margin-bottom: 10px;\\\">Attendance Marked Successfully!</h3>\\n                  <p style=\\\"color: #555; margin-bottom: 20px;\\\">\".concat(response.data.message,\"</p>\\n                  <button onclick=\\\"window.location.reload()\\\" style=\\\"\\n                    background: linear-gradient(135deg, #27ae60, #219a52);\\n                    color: white;\\n                    border: none;\\n                    padding: 10px 25px;\\n                    border-radius: 20px;\\n                    cursor: pointer;\\n                    font-size: 14px;\\n                  \\\">Close & Return to Dashboard</button>\\n                </div>\\n              \");}catch(err){var _err$response,_err$response2,_err$response3,_err$response3$data,_err$response4;console.error(\"Attendance submission error:\",err);console.error(\"Error details:\",{message:err.message,response:err.response,status:(_err$response=err.response)===null||_err$response===void 0?void 0:_err$response.status,data:(_err$response2=err.response)===null||_err$response2===void 0?void 0:_err$response2.data,config:err.config});// Check if it's a 401 error (token expired)\nif(err.response&&err.response.status===401){var _err$response$data;const errorMessage=\"Authentication failed: \".concat(((_err$response$data=err.response.data)===null||_err$response$data===void 0?void 0:_err$response$data.message)||'Token expired');console.error(\"401 Error:\",errorMessage);// Show error message instead of immediate redirect\ndocument.querySelector(\".form-popup-inner\").innerHTML=\"\\n                  <div style=\\\"text-align: center; padding: 20px;\\\">\\n                    <div style=\\\"font-size: 48px; margin-bottom: 15px;\\\">\\uD83D\\uDD10</div>\\n                    <h3 style=\\\"color: #e74c3c; margin-bottom: 10px;\\\">Authentication Error!</h3>\\n                    <p style=\\\"color: #555; margin-bottom: 10px; font-weight: bold;\\\">Status: 401 Unauthorized</p>\\n                    <p style=\\\"color: #555; margin-bottom: 20px;\\\">\".concat(errorMessage,\"</p>\\n                    <button onclick=\\\"localStorage.removeItem('token'); window.location.href='/login';\\\" style=\\\"\\n                      background: linear-gradient(135deg, #3498db, #2980b9);\\n                      color: white;\\n                      border: none;\\n                      padding: 10px 25px;\\n                      border-radius: 20px;\\n                      cursor: pointer;\\n                      font-size: 14px;\\n                      margin-right: 10px;\\n                    \\\">Go to Login</button>\\n                    <button onclick=\\\"location.reload()\\\" style=\\\"\\n                      background: linear-gradient(135deg, #95a5a6, #7f8c8d);\\n                      color: white;\\n                      border: none;\\n                      padding: 10px 25px;\\n                      border-radius: 20px;\\n                      cursor: pointer;\\n                      font-size: 14px;\\n                    \\\">Retry</button>\\n                  </div>\\n                \");return;}// Get specific error message from server if available\nconst errorMessage=((_err$response3=err.response)===null||_err$response3===void 0?void 0:(_err$response3$data=_err$response3.data)===null||_err$response3$data===void 0?void 0:_err$response3$data.message)||err.message||\"Unknown error occurred\";const statusCode=((_err$response4=err.response)===null||_err$response4===void 0?void 0:_err$response4.status)||'Unknown';console.error(\"Full error object:\",err);// Show detailed error message\ndocument.querySelector(\".form-popup-inner\").innerHTML=\"\\n                <div style=\\\"text-align: center; padding: 20px;\\\">\\n                  <div style=\\\"font-size: 48px; margin-bottom: 15px;\\\">\\u274C</div>\\n                  <h3 style=\\\"color: #e74c3c; margin-bottom: 10px;\\\">Attendance Failed!</h3>\\n                  <p style=\\\"color: #555; margin-bottom: 10px; font-weight: bold;\\\">Status Code: \".concat(statusCode,\"</p>\\n                  <p style=\\\"color: #555; margin-bottom: 10px; font-family: monospace; background: #f8f9fa; padding: 10px; border-radius: 5px;\\\">\").concat(errorMessage,\"</p>\\n                  <div style=\\\"margin-bottom: 20px;\\\">\\n                    <button onclick=\\\"console.log('Full error:', \").concat(JSON.stringify(err,null,2).replace(/\"/g,'\\\\\"'),\")\\\" style=\\\"\\n                      background: #6c757d;\\n                      color: white;\\n                      border: none;\\n                      padding: 5px 15px;\\n                      border-radius: 15px;\\n                      cursor: pointer;\\n                      font-size: 12px;\\n                      margin-bottom: 10px;\\n                    \\\">Log Full Error to Console</button>\\n                  </div>\\n                  <button onclick=\\\"location.reload()\\\" style=\\\"\\n                    background: linear-gradient(135deg, #e74c3c, #c0392b);\\n                    color: white;\\n                    border: none;\\n                    padding: 10px 25px;\\n                    border-radius: 20px;\\n                    cursor: pointer;\\n                    font-size: 14px;\\n                    margin-right: 10px;\\n                  \\\">Try Again</button>\\n                  <button onclick=\\\"window.location.href='/student-dashboard'\\\" style=\\\"\\n                    background: linear-gradient(135deg, #95a5a6, #7f8c8d);\\n                    color: white;\\n                    border: none;\\n                    padding: 10px 25px;\\n                    border-radius: 20px;\\n                    cursor: pointer;\\n                    font-size: 14px;\\n                  \\\">Back to Dashboard</button>\\n                </div>\\n              \");}}else{alert(\"Please fill all the fields\");}},error=>{console.error(\"Error getting geolocation:\",error);});}else{alert(\"Geolocation is not supported by this browser.\");console.error(\"Geolocation is not supported by this browser.\");}};// useEffect to handle component cleanup\nuseEffect(()=>{// Cleanup function to stop camera when component unmounts\nreturn()=>{const video=videoRef.current;if(video&&video.srcObject){const stream=video.srcObject;const tracks=stream.getTracks();tracks.forEach(track=>track.stop());video.srcObject=null;}};},[]);return/*#__PURE__*/_jsxs(\"div\",{className:\"form-popup\",children:[/*#__PURE__*/_jsx(\"button\",{onClick:togglePopup,children:/*#__PURE__*/_jsx(\"strong\",{children:\"X\"})}),/*#__PURE__*/_jsxs(\"div\",{className:\"form-popup-inner\",children:[/*#__PURE__*/_jsx(\"h5\",{children:\"Enter Your Details\"}),!photoData&&/*#__PURE__*/_jsx(\"video\",{ref:videoRef,width:300,autoPlay:true}),photoData&&/*#__PURE__*/_jsx(\"img\",{src:photoData,width:300,alt:\"Captured\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"cam-btn\",children:[/*#__PURE__*/_jsx(\"button\",{onClick:isCameraActive?stopCamera:startCamera,children:isCameraActive?'Stop Camera':'Start Camera'}),/*#__PURE__*/_jsx(\"button\",{onClick:capturePhoto,disabled:!isCameraActive,children:\"Capture\"}),/*#__PURE__*/_jsx(\"button\",{onClick:ResetCamera,children:\"Reset\"})]}),/*#__PURE__*/_jsxs(\"form\",{onSubmit:AttendSession,children:[/*#__PURE__*/_jsx(\"input\",{type:\"text\",name:\"regno\",placeholder:\"RegNo\",autoComplete:\"off\"}),/*#__PURE__*/_jsx(\"button\",{type:\"submit\",children:\"Done\"})]})]})]});};export default StudentForm;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}